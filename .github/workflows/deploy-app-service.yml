name: Deploy to Azure App Service (when quota available)

on:
  workflow_dispatch:  # Manual trigger only

env:
  IMAGE_NAME_APP: firatech_streamlit_app
  IMAGE_NAME_GATEWAY: firatech_gateway

jobs:
  deploy-to-app-service:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sanitize AZURE_CREDENTIALS JSON
        id: sanitize-creds
        shell: bash
        env:
          AZ_CREDS_RAW: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          python - <<'PY'
          import json, os, sys
          raw = os.environ.get("AZ_CREDS_RAW", "")
          raw = raw.encode("utf-8").decode("utf-8-sig").strip()
          try:
            data = json.loads(raw)
          except Exception as exc:
            print(f"::error::Failed to parse AZURE_CREDENTIALS: {exc}")
            sys.exit(1)
          cleaned = json.dumps(data)
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            fh.write(f"creds={cleaned}\n")
          print(f"Sanitized creds length: {len(cleaned)}")
          PY

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ steps.sanitize-creds.outputs.creds }}

      - name: Login to ACR
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
        run: |
          az acr login --name "$ACR_NAME"

      - name: Create App Service Plan (B1 tier)
        run: |
          az appservice plan create \
            --name yatas-plan \
            --resource-group yatas-rg \
            --is-linux \
            --sku B1 || echo "Plan already exists or quota insufficient"

      - name: Create Web App for Streamlit
        run: |
          az webapp create \
            --resource-group yatas-rg \
            --plan yatas-plan \
            --name yatas-app \
            --deployment-container-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME_APP }}:latest || echo "App already exists"

      - name: Configure Web App container settings
        run: |
          ACR_USER=$(az acr credential show --name ${{ secrets.ACR_NAME }} --query username -o tsv)
          ACR_PASS=$(az acr credential show --name ${{ secrets.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          az webapp config container set \
            --name yatas-app \
            --resource-group yatas-rg \
            --docker-custom-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME_APP }}:latest \
            --docker-registry-server-url https://${{ secrets.ACR_LOGIN_SERVER }} \
            --docker-registry-server-user $ACR_USER \
            --docker-registry-server-password $ACR_PASS

      - name: Configure App Settings
        run: |
          az webapp config appsettings set \
            --resource-group yatas-rg \
            --name yatas-app \
            --settings \
              SAP_GATEWAY_DEMO=0 \
              PORT=80 \
              SAP_API_BASE_URL=https://yatas-gateway.azurewebsites.net/api \
              WEBSITES_PORT=80

      - name: Create Web App for Gateway
        run: |
          az webapp create \
            --resource-group yatas-rg \
            --plan yatas-plan \
            --name yatas-gateway \
            --deployment-container-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME_GATEWAY }}:latest || echo "Gateway app already exists"

      - name: Configure Gateway Web App
        run: |
          ACR_USER=$(az acr credential show --name ${{ secrets.ACR_NAME }} --query username -o tsv)
          ACR_PASS=$(az acr credential show --name ${{ secrets.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          az webapp config container set \
            --name yatas-gateway \
            --resource-group yatas-rg \
            --docker-custom-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME_GATEWAY }}:latest \
            --docker-registry-server-url https://${{ secrets.ACR_LOGIN_SERVER }} \
            --docker-registry-server-user $ACR_USER \
            --docker-registry-server-password $ACR_PASS
          
          az webapp config appsettings set \
            --resource-group yatas-rg \
            --name yatas-gateway \
            --settings PORT=5000 WEBSITES_PORT=5000

      - name: Output URLs
        run: |
          echo "App URL: https://yatas-app.azurewebsites.net"
          echo "Gateway URL: https://yatas-gateway.azurewebsites.net"
